name: Oracle Cloud ë°°í¬

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js (24) ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: pnpm ì„¤ì¹˜
        run: npm install -g pnpm

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install

      - name: ë¹Œë“œ
        run: pnpm build

      - name: ë¹Œë“œ íŒŒì¼ ì••ì¶•
        run: |
          mkdir -p deploy
          cp -r .next package.json pnpm-lock.yaml server public deploy/

          rm -rf \
            deploy/public/pages \
            deploy/.next/cache \
            deploy/.next/server/dev \
            deploy/node_modules \
            deploy/.git \
            deploy/.github

          cd deploy
          tar -czf ../build.tar.gz .
          cd ..
          echo "ğŸ“¦ ë¹Œë“œ ì••ì¶• ì™„ë£Œ ($(du -h build.tar.gz | cut -f1))"

      - name: Oracle Cloud ì„œë²„ ë°°í¬
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          echo "$SSH_PRIVATE_KEY" > key.pem
          chmod 600 key.pem

          echo "ğŸ“¦ ì„œë²„ì— íŒŒì¼ ì „ì†¡ ì¤‘..."
          scp -i key.pem -o StrictHostKeyChecking=no build.tar.gz $SERVER_USER@$SERVER_HOST:~/yoguhaeyo.tar.gz

          echo "ğŸš€ ì„œë²„ ë°°í¬ ë° ì‹¤í–‰ ì¤‘..."
          ssh -i key.pem -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            export PATH="$HOME/.local/share/pnpm:$PATH"

            echo "ğŸ§¹ ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì •ë¦¬..."
            if [ -f ~/yoguhaeyo/.env ]; then
              echo "ğŸ“ .env ë°±ì—…..."
              cp ~/yoguhaeyo/.env ~/yoguhaeyo.env.backup
            fi

            rm -rf ~/yoguhaeyo && mkdir -p ~/yoguhaeyo

            echo "ğŸ“¦ ì••ì¶• í•´ì œ..."
            tar -xzf ~/yoguhaeyo.tar.gz -C ~/yoguhaeyo

            if [ -f ~/yoguhaeyo.env.backup ]; then
              echo "ğŸ” .env ë³µì›..."
              mv ~/yoguhaeyo.env.backup ~/yoguhaeyo/.env
            fi

            cd ~/yoguhaeyo
            export NODE_ENV=production

            if ! command -v pnpm &> /dev/null; then
              echo "ğŸ”§ pnpm ì„¤ì¹˜ ì¤‘..."
              curl -fsSL https://get.pnpm.io/install.sh | sh -
              export PATH="$HOME/.local/share/pnpm:$PATH"
            fi

            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ”§ pm2 ì„¤ì¹˜ ì¤‘..."
              npm install -g pm2
            fi

            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            pnpm install --prod

            echo "â™»ï¸ ì•± ì¬ì‹œì‘ ì¤‘..."
            pm2 stop yoguhaeyo || true
            pm2 start server/index.js --name yoguhaeyo --update-env
            pm2 save

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          ENDSSH

          rm key.pem
